#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# SOURCE FILE
# Edit here: ~/leo-services/leo/bin/mes-run
# Install with: leo install
# DO NOT edit /usr/local/bin/mes-run directly
"""
MES Operator Command – mes-run
================================================
Version: 1.7.0 (refined ops)

Purpose:
- Lean entrypoint for MES control (scalp/swing + demo/live)
- Safe timer/service management via systemd
- Quick status, explain, journal

Changes in 1.7.0:
- Shortened help menu
- Consolidated enable/disable into 'timer' command
- Simplified explain output
- Removed verbose usage block
"""

import sys
import subprocess
from datetime import datetime

# ============================================================
# Colors & Symbols
# ============================================================
GREEN = "\033[92m"
YELLOW = "\033[93m"
RED = "\033[91m"
RESET = "\033[0m"
OK = "✔"
WARN = "⚠️"
FAIL = "❌"

# ============================================================
# Helpers
# ============================================================
def run(cmd: str) -> str:
    output = subprocess.run(cmd, shell=True, capture_output=True, text=True).stdout
    return output.splitlines()[0].strip() if output else ""

def run_check(cmd: str) -> int:
    return subprocess.run(cmd, shell=True).returncode

def run_passthrough(cmd: str):
    subprocess.run(cmd, shell=True)

def unit_state_timer(timer: str) -> dict:
    return {
        "active": run(f"systemctl is-active {timer} 2>/dev/null || echo inactive"),
        "enabled": run(f"systemctl is-enabled {timer} 2>/dev/null || echo disabled"),
    }

def unit_state_service(service: str) -> str:
    return run(f"systemctl is-active {service} 2>/dev/null || echo inactive")

def last_service_run(service: str) -> str:
    return run(f"journalctl -u {service} -n 1 --no-pager | sed -E 's/^([^ ]+ [^ ]+).*/\\1/'")

def next_timer_fire(timer: str) -> str:
    raw = run(f"systemctl show {timer} -p NextElapseUSecRealtime")
    return raw.split("=", 1)[1] if "=" in raw else "n/a"

# ============================================================
# Core Actions
# ============================================================
def run_once(service: str):
    run_check(f"sudo systemctl start {service}")
    print(f"{OK} {service} executed once")

def timer_control(timer: str, action: str):
    print(f"\n{action.capitalize()}ing {timer}...\n")
    if action == "enable":
        run_check(f"sudo systemctl daemon-reload && sudo systemctl enable {timer} && sudo systemctl start {timer}")
    else:
        run_check(f"sudo systemctl stop {timer} && sudo systemctl disable {timer}")
    
    state = unit_state_timer(timer)
    status = "enabled and running" if state["enabled"] == "enabled" and state["active"] == "active" else state
    print(f"{OK if state['enabled'] == ('enabled' if action == 'enable' else 'disabled') else FAIL} {timer} {action}d → {status}")

def explain_service(service: str, timer: str):
    svc = unit_state_service(service)
    tmr = unit_state_timer(timer)
    failed = run(f"systemctl is-failed {service}")

    print(f"\n=== MES {service.upper()} ===\n")
    if tmr["enabled"] == "disabled":
        print("Status: DISABLED (timer off) — Enable with: mes-run <strat> timer enable <env>")
        return
    if svc == "active":
        print("Status: RUNNING")
        return
    if failed != "failed":
        print(f"Status: IDLE (OK) — Next fire: {next_timer_fire(timer)}")
        return
    print(f"{RED}Status: FAILED{RESET}")
    print("Quick fix hints:")
    print(" • Check credentials (OANDA env vars)")
    print(" • Verify script path/permissions")
    print(" • Run 'mes-run <strat> journal <env>' for logs")

# ============================================================
# Status
# ============================================================
def status():
    print("\n=== MES STATUS ===")
    print(f"Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
    
    def block(title, service, timer):
        print(f"[{title}]")
        print(f"  Timer:  {unit_state_timer(timer)}")
        print(f"  Service: {unit_state_service(service)}")
        print(f"  Last:   {last_service_run(service) or 'n/a'}")
        print(f"  Next:   {next_timer_fire(timer)}\n")
    
    block("SCALP DEMO", "mes_scalp_demo.service", "mes_scalp_demo.timer")
    block("SCALP LIVE", "mes_scalp_live.service", "mes_scalp_live.timer")
    block("SWING DEMO", "mes_swing_demo.service", "mes_swing_demo.timer")
    block("SWING LIVE", "mes_swing_live.service", "mes_swing_live.timer")

# ============================================================
# Help
# ============================================================
def help_menu():
    print("\nMES Operator – mes-run (v1.7.0)\n")
    print("Commands:")
    print("  mes-run status                  Quick health overview")
    print("  mes-run <scalp|swing> demo|live Run once (play/real money)")
    print("  mes-run <scalp|swing> timer enable|disable demo|live")
    print("  mes-run <scalp|swing> explain demo|live  Status + failure hints")
    print("  mes-run <scalp|swing> journal demo|live [-f]  Tail logs\n")

# ============================================================
# Entrypoint
# ============================================================
if __name__ == "__main__":
    if len(sys.argv) < 2 or sys.argv[1].lower() in ("help", "-h"):
        help_menu()
        sys.exit(0)

    cmd = sys.argv[1].lower()
    
    if cmd == "status":
        status()
    elif cmd in ("scalp", "swing") and len(sys.argv) >= 3:
        strat = cmd
        action = sys.argv[2].lower()
        
        if action in ("demo", "live"):
            run_once(f"mes_{strat}_{action}.service")
        elif action == "timer" and len(sys.argv) == 5 and sys.argv[3].lower() in ("enable", "disable") and sys.argv[4].lower() in ("demo", "live"):
            timer = f"mes_{strat}_{sys.argv[4]}.timer"
            timer_control(timer, sys.argv[3].lower())
        elif action == "explain" and len(sys.argv) == 4 and sys.argv[3].lower() in ("demo", "live"):
            explain_service(f"mes_{strat}_{sys.argv[3]}.service", f"mes_{strat}_{sys.argv[3]}.timer")
        elif action == "journal" and len(sys.argv) >= 4 and sys.argv[3].lower() in ("demo", "live"):
            follow = "-f" in sys.argv
            run_passthrough(f"journalctl -u mes_{strat}_{sys.argv[3]}.service {'-f' if follow else '-n 30 --no-pager'}")
        else:
            help_menu()
    else:
        help_menu()