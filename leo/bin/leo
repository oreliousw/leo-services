#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Leo System Command â€“ leo
================================================
Version: 1.9.3 (refined daily ops)
Changes in 1.9.3:
- leo deploy code now verifies each service restart and reports success/failure per service
- Clear green/red feedback â€“ no more silent failures
"""
import sys
import subprocess
from datetime import datetime
from shutil import which
from pathlib import Path

# ============================================================
# Paths
# ============================================================
LEO_SRC = Path.home() / "leo-services" / "leo" / "bin"
MES_SCALP_SRC = Path.home() / "leo-services" / "mes" / "mes_scalp.py"
MES_SWING_SRC = Path.home() / "leo-services" / "mes" / "mes_swing.py"
MES_SCALP_DEST = Path("/opt/mes/mes_scalp.py")
MES_SWING_DEST = Path("/opt/mes/mes_swing.py")
EDITABLE_FILES = {
    "mes-run": LEO_SRC / "mes-run",
    "leo": LEO_SRC / "leo",
}

# ============================================================
# Helpers
# ============================================================
def run(cmd: str, capture=False):
    if capture:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        return result.returncode == 0, result.stdout + result.stderr
    else:
        subprocess.run(cmd, shell=True, check=True)

def red(text: str):
    print(f"\033[91m{text}\033[0m")

def green(text: str):
    print(f"\033[92m{text}\033[0m")

def yellow(text: str):
    print(f"\033[93m{text}\033[0m")

def header():
    print("\n=== LEO SYSTEM ===")
    print(f"Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")

def has_cmd(cmd: str) -> bool:
    return which(cmd) is not None

def open_editor(path: Path):
    if not path.exists():
        red(f"File not found: {path}")
        return
    if has_cmd("code"):
        run(f"code --wait {path}")
    elif has_cmd("vim"):
        run(f"vim {path}")
    elif has_cmd("nano"):
        run(f"nano {path}")
    else:
        red("No editor found (code/vim/nano)")

def confirm(prompt: str) -> bool:
    while True:
        r = input(f"{prompt} (y/n): ").lower().strip()
        if r in ("y", "yes"):
            return True
        if r in ("n", "no"):
            return False
        print("Please answer y or n.")

# ============================================================
# Core Deploy Code â€“ now with restart verification
# ============================================================
def deploy_code():
    header()
    yellow("Deploying latest MES code (scalp + swing) to active use...")

    # Copy files
    try:
        run(f"sudo cp -f {MES_SCALP_SRC} {MES_SCALP_DEST}")
        run(f"sudo cp -f {MES_SWING_SRC} {MES_SWING_DEST}")
        run(f"sudo chmod 644 {MES_SCALP_DEST} {MES_SWING_DEST}")
        green("âœ” Files copied successfully")
    except subprocess.CalledProcessError:
        red("âœ– Copy failed â€“ aborting")
        sys.exit(1)

    # Restart services with feedback
    services = [
        "mes_scalp_demo.service",
        "mes_scalp_live.service",
        "mes_swing_demo.service",
        "mes_swing_live.service",
    ]
    print("\nRestarting services...")
    all_good = True
    for svc in services:
        success, output = run(f"sudo systemctl restart {svc}", capture=True)
        if success:
            green(f"  âœ” {svc}")
        else:
            all_good = False
            red(f"  âœ– {svc} â€“ restart failed")
            if output.strip():
                print(f"    â†’ {output.strip().replace(chr(10), ' | ')}")
    if all_good:
        green("\nâœ” All services restarted cleanly â€“ ready for demo or live")
    else:
        yellow("\nâš  Code deployed but some restarts failed â€“ check journalctl")

# ============================================================
# Usage
# ============================================================
def usage():
    header()
    print("Daily commands:\n")
    print(" leo status       System health overview")
    print(" leo edit [leo|mes-run] Edit operator tools + optional install")
    print(" leo deploy code  Copy latest scalp + swing to active use + verify restarts")
    print(" leo mes          MES operator (mes-run wrapper)")
    print(" leo update       System package updates")
    print(" leo reboot       Reboot system (confirm)\n")
    sys.exit(0)

# ============================================================
# Commands (unchanged except deploy)
# ============================================================
def status():
    header()
    run("uptime")
    print("")
    run("df -h / | tail -n 1")
    print("")
    try:
        run("systemctl --failed")
    except subprocess.CalledProcessError:
        pass

def edit():
    header()
    if len(sys.argv) == 2:
        print("Editable operator files:\n")
        for k in EDITABLE_FILES:
            print(f" leo edit {k}")
        print("")
        return
    target = sys.argv[2].lower()
    if target not in EDITABLE_FILES:
        red(f"Unknown target: {target}")
        edit()
        return
    path = EDITABLE_FILES[target]
    print(f"Opening {path} ...")
    open_editor(path)
    if confirm(f"Install updated {target} now?"):
        installer = LEO_SRC / "leo-install"
        if not installer.exists():
            red("leo-install script missing")
            return
        run(str(installer))
        green(f"\nâœ” {target} installed")

def deploy():
    deploy_code()

def mes():
    if len(sys.argv) > 2:
        run(f"mes-run {' '.join(sys.argv[2:])}")
    else:
        run("mes-run status")

def update():
    header()
    run("sudo apt update")
    run("sudo apt upgrade -y")
    run("sudo apt autoremove -y")
    green("\nã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå®Œäº† ðŸ˜º")

def reboot():
    header()
    if confirm("Reboot Leo system now?"):
        run("sudo reboot")

# ============================================================
# Entrypoint
# ============================================================
if __name__ == "__main__":
    if len(sys.argv) == 1 or sys.argv[1] in ("help", "-h", "--help"):
        usage()
    cmd = sys.argv[1].lower()
    if cmd == "status":
        status()
    elif cmd == "edit":
        edit()
    elif cmd == "deploy":
        deploy()
    elif cmd == "mes":
        mes()
    elif cmd == "update":
        update()
    elif cmd == "reboot":
        reboot()
    else:
        red(f"Unknown command: {cmd}")
        usage()